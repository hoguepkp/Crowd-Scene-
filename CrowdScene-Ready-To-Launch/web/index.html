<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CrowdScene â€” Live Nightlife Map</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#0b0f14;color:#e9f1f7}
  header{padding:12px 16px;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:12px;position:sticky;top:0;background:#0b0f14;z-index:5}
  .chip{border:1px solid #1f2937;border-radius:999px;padding:4px 8px;font-size:12px;color:#8da0b3}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button{background:#0f141b;border:1px solid #1f2937;color:#e9f1f7;padding:8px 10px;border-radius:10px}
  button.primary{background:#38b6ff;border:none;color:#04121d;font-weight:700;cursor:pointer}
  #map{height: calc(100vh - 62px); width: 100%}
  #panel{position:absolute;top:70px;left:12px;z-index:6;background:#0f141b;border:1px solid #1f2937;border-radius:14px;padding:10px;max-width:360px}
  .item{border-bottom:1px solid #1f2937;padding:8px 0}
  .item:last-child{border-bottom:none}
  .crowd.bad{color:#ef4444;font-weight:700}.crowd.warn{color:#f59e0b;font-weight:700}.crowd.ok{color:#21c55d;font-weight:700}
  .pill{border:1px solid #1f2937;border-radius:999px;padding:2px 8px;font-size:12px;color:#8da0b3}
</style>
</head>
<body>
<header>
  <div style="font-weight:800">CrowdScene</div>
  <div class="chip">Live venues â€¢ Check-ins</div>
  <div class="row" style="margin-left:auto">
    <input id="lat" type="number" step="0.000001" placeholder="lat">
    <input id="lng" type="number" step="0.000001" placeholder="lng">
    <input id="radius" type="number" step="0.5" value="5" min="0.5" max="25">
    <button id="useGeo">Use my location</button>
    <button class="primary" id="searchBtn">Search</button>
  </div>
</header>

<div id="panel">
  <div class="row">
    <button id="toggleSource" title="Switch between manual venues and Google Places">Source: <span id="sourceLbl">Google Places</span></button>
    <button id="checkinBtn" class="primary">Check in here</button>
  </div>
  <div id="info" style="margin-top:8px;font-size:13px;color:#8da0b3">Click a marker for details.</div>
  <div id="list"></div>
</div>

<div id="map"></div>

<script>
const API_BASE = "http://localhost:4000"; // replace with your Render URL when deployed
const API = (path, opts={}) => fetch(`${API_BASE}${path}`, { headers: { 'Content-Type': 'application/json' }, ...opts }).then(r => r.json());

let map, markers = [], heatCircles = [], selectedId = null, usePlaces = true;
let userId = localStorage.getItem('userId');

async function ensureUser(){
  if(!userId){
    const r = await API('/api/users/anon', { method:'POST', body: JSON.stringify({}) });
    userId = r.id; localStorage.setItem('userId', userId);
  }
}
ensureUser();

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat: 37.7749, lng:-122.4194 }, zoom: 13 });
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos => {
      const c = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setCenter(c);
      document.getElementById('lat').value = c.lat.toFixed(6);
      document.getElementById('lng').value = c.lng.toFixed(6);
    });
  }
  document.getElementById('searchBtn').click();
}

function crowdLabel(x){
  if(x < 2) return { t:'Chill', cls:'ok' };
  if(x < 5) return { t:'Lively', cls:'warn' };
  return { t:'Packed', cls:'bad' };
}

async function search(){
  const lat = parseFloat(document.getElementById('lat').value);
  const lng = parseFloat(document.getElementById('lng').value);
  const radius = parseFloat(document.getElementById('radius').value);
  if(Number.isNaN(lat) || Number.isNaN(lng)){ alert('Enter lat/lng'); return; }

  const path = usePlaces ? `/api/places/nearby?lat=${lat}&lng=${lng}&radius=${radius}`
                         : `/api/venues/nearby?lat=${lat}&lng=${lng}&radius=${radius}`;
  const data = await API(path);
  renderList(data);
  plot(data);
}

function renderList(items){
  const list = document.getElementById('list');
  list.innerHTML = items.slice(0, 25).map(v => {
    const c = crowdLabel(v.crowd);
    return `<div class="item">
      <div><strong>${v.name}</strong> <span class="pill">${v.type||''}</span> <span class="pill">$${v.cover||0} cover</span></div>
      ${v.event ? `<div>ðŸŽ¶ ${v.event}</div>`: ''}
      <div><span class="crowd ${c.cls}">${c.t}</span> â€¢ ${v.distance?.toFixed(2)} mi</div>
      <button onclick="selectVenue('${v.id}', ${v.lat}, ${v.lng})">Focus</button>
      <button onclick="checkin('${v.id}')">Check in</button>
    </div>`;
  }).join('');
}

function selectVenue(id, lat, lng){
  selectedId = id;
  map.panTo({lat, lng});
  document.getElementById('info').textContent = `Selected: ${id}`;
}

async function checkin(venueId){
  await ensureUser();
  const r = await API('/api/checkins', { method:'POST', body: JSON.stringify({ userId, venueId })});
  if(r.error){ alert(r.error); return; }
  selectedId = venueId;
  search();
}

function plot(items){
  markers.forEach(m => m.setMap(null)); markers = [];
  heatCircles.forEach(c => c.setMap(null)); heatCircles = [];

  items.forEach(v => {
    const m = new google.maps.Marker({ position:{ lat:v.lat, lng:v.lng }, map, title: v.name });
    m.addListener('click', () => { selectedId = v.id; showInfo(v); });
    markers.push(m);

    const radius = Math.min(400, 40 + v.crowd * 30);
    const c = new google.maps.Circle({
      strokeOpacity: 0, fillOpacity: 0.25, map, center:{lat:v.lat,lng:v.lng}, radius
    });
    heatCircles.push(c);
  });
}

function showInfo(v){
  const c = crowdLabel(v.crowd);
  document.getElementById('info').innerHTML = `<strong>${v.name}</strong> â€¢ <span class="crowd ${c.cls}">${c.t}</span><br>
    ${v.type||''} â€¢ $${v.cover||0} cover ${v.event ? 'â€¢ ðŸŽ¶ '+v.event : ''}`;
}

document.getElementById('useGeo').addEventListener('click', () => {
  if(!navigator.geolocation) return alert('No geolocation');
  navigator.geolocation.getCurrentPosition(pos => {
    document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
    document.getElementById('lng').value = pos.coords.longitude.toFixed(6);
  });
});
document.getElementById('searchBtn').addEventListener('click', search);
document.getElementById('toggleSource').addEventListener('click', () => {
  usePlaces = !usePlaces;
  document.getElementById('sourceLbl').textContent = usePlaces ? 'Google Places' : 'Manual';
  search();
});
</script>
<!-- Replace YOUR_GOOGLE_MAPS_API_KEY with your key -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=visualization&callback=initMap"></script>
</body>
</html>
